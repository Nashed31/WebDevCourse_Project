<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Hub | Register</title>

    <script>
        if (sessionStorage.getItem('loggedUser')) window.location.replace('search.html');
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styleAuth.css">

</head>

<body>
    <nav class="navbar navbar-expand navbar-dark navbar-custom shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-house"></i></a>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="container bg-white p-4 p-md-5 rounded-5 shadow-lg" style="max-width: 550px;">
            <header class="bg-custom-primary text-white text-center py-3 rounded-4 mb-4">
                <h1 class="h4 fw-bold mb-0">Create Account</h1>
            </header>

            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label class="form-label fw-bold text-custom-primary">Username</label>
                    <input type="text" id="userName" class="form-control" placeholder="Choose a unique username">
                    <div class="invalid-feedback" id="userError">Username is required.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-custom-primary">Private Name</label>
                    <input type="text" id="privateName" class="form-control" placeholder="Enter your full name">
                    <div class="invalid-feedback">Field is required.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-custom-primary">Profile Picture URL</label>
                    <input type="url" id="picUrl" class="form-control" placeholder="https://example.com/image.jpg">
                    <div class="invalid-feedback">Valid URL required.</div>
                </div>

                <div class="row g-3 mb-2">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-custom-primary">Password</label>
                        <input type="password" id="pass" class="form-control" placeholder="**********">
                        <div class="invalid-feedback" id="passError">Min 6 chars: 1 Letter, 1 Number, 1 Symbol.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-custom-primary">Confirm</label>
                        <input type="password" id="passConfirm" class="form-control" placeholder="**********">
                        <div class="invalid-feedback">Passwords must match.</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-custom w-100 py-3 rounded-3 fw-bold shadow-sm mt-4 mb-3">Register &
                    Continue</button>

                <div class="text-center">
                    <span class="text-secondary">Already have an account?</span>
                    <a href="login.html" class="text-custom-primary fw-bold text-decoration-none">Login here</a>
                </div>
            </form>
        </div>
    </div>

    <footer class="text-center text-muted small">
        © 2026 Telhai WebDev Course Project • Nashed Awidat
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.body.style.display = "flex";

        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => input.classList.remove('is-invalid'));

            let isValid = true;
            const userName = document.getElementById('userName');
            const privateName = document.getElementById('privateName');
            const userPic = document.getElementById('picUrl');
            const password = document.getElementById('pass');
            const passwordConfirm = document.getElementById('passConfirm');

            // Client-side required field check
            [userName, privateName, userPic, password, passwordConfirm].forEach(inp => {
                if (!inp.value.trim()) {
                    inp.classList.add('is-invalid'); isValid = false;
                }
            });

            // Password complexity check
            const passRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{6,}$/;
            if (password.value && !passRegex.test(password.value)) {
                password.classList.add('is-invalid');
                isValid = false;
            }

            // Confirm password check
            if (password.value !== passwordConfirm.value) {
                passwordConfirm.classList.add('is-invalid');
                isValid = false;
            }

            if (!isValid) return;


            try {
                const userData = {
                    username: userName.value.trim(),
                    privateName: privateName.value.trim(),
                    picUrl: userPic.value.trim(),
                    password: password.value
                };

                const response = await fetch('http://localhost:3000/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    window.location.href = 'login.html';
                } else {
                    // Handle server-side errors (like "Username taken")
                    userName.classList.add('is-invalid');
                    document.getElementById('userError').innerText = data.error || "Registration failed.";
                }
            } catch (error) {
                console.error("Connection error:", error);
                alert("Cannot connect to server. Make sure server.js is running.");
            }
        });
    </script>
</body>

</html>